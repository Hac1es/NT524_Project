filter {
  if [fields][service_type] == "keycloak" {
    
    # 1. PARSE HEADER (Lấy Timestamp, Level, Thread...)
    grok {
      match => { 
        # Pattern bắt chuẩn format: 2025-12-21 05:32:07,070 DEBUG [class] (thread) ...
        "message" => "%{TIMESTAMP_ISO8601:timestamp_raw}\s+%{LOGLEVEL:level}\s+\[%{DATA:component}\]\s+\(%{DATA:thread}\)\s+%{GREEDYDATA:log_data}" 
      }
    }

    # 2. Lọc log rác, chỉ giữ lại log quan trọng
    # Bọn Hibernate/SQL nói nhiều vãi chưởng -> DROP NGAY
    if [component] =~ "org.hibernate" or [component] =~ "org.infinispan" {
        drop {}
    }
    # Chỉ xử lý nếu là Lỗi HOẶC chứa từ khóa nghiệp vụ
    # Chỉ xử lý log từ 'org.keycloak.events' (Đây là log nghiệp vụ Login/SSO xịn)
    if [component] == "org.keycloak.events" {
        
        # 3. PARSE KEY-VALUE, dùng KV filter tự động bắt key="value"
        kv {
            source => "log_data"
            field_split => ", " # Các cặp cách nhau bằng dấu phẩy + space
            value_split => "="  # Key nối Value bằng dấu bằng
            trim_value => "\""  # Tự động cắt bỏ dấu ngoặc kép bao quanh value ("tungzeka" -> tungzeka)
            # Quan trọng: Loại bỏ các key rác nếu có
            remove_field => ["log_data"]
        }

        # 4. NORMALIZATION
        # A. Chỉ tạo attributes nếu đã bắt được Username
        if [username] {
             mutate {
                add_field => { 
                    "attributes" => "AuthMethod: %{auth_method} | User: %{username} | Realm: %{realmName}"
                }
             }
        }
        # B. Map Timezone (Lưu ý: Log Keycloak dùng dấu phẩy cho mili giây)
        date {
            match => [ "timestamp_raw", "yyyy-MM-dd HH:mm:ss,SSS" ]
            timezone => "Etc/UTC" 
            target => "@timestamp"
        }

        # C. Map Fields sang tên chuẩn
        mutate {
            # Rename các field gốc của Keycloak
            rename => { "type" => "event_type" }    # LOGIN -> event_type
            rename => { "ipAddress" => "ip" }       # ipAddress -> ip
            rename => { "userId" => "user_id" }     # userId (UUID) -> user_id
            rename => { "clientId" => "client_id" } # keystone -> client_id
            
            # Khởi tạo các field cố định
            add_field => {
                "idp" => "Keycloak"    # Cái này là log Keycloak nên IdP chắc chắn là nó
                "sp" => "Keycloak"    # Service Provider là Keycloak
                "user_agent" => "unknown" # Log Keycloak sự kiện (Event) thường ko ghi UserAgent
            }
        }
        
        # D. Xử lý Outcome (Thành công/Thất bại)
        if [event_type] =~ "_ERROR" or [level] == "ERROR" or [level] == "WARN" {
            mutate { add_field => { "outcome" => "failure" } }
        } else {
            mutate { add_field => { "outcome" => "success" } }
        }

        # E. (Đã xử lý ở bước 4.A - chỉ add attributes nếu có username)

        # F. GeoIP Lookup (Lấy vị trí từ IP)
        if [ip] and [ip] != "127.0.0.1" and [ip] != "0:0:0:0:0:0:0:1" {
            geoip {
                source => "ip"
                target => "geo"
                ecs_compatibility => disabled
                fields => ["city_name", "country_name", "location"]
            }
             if [geo][location] {
                mutate { add_field => { "geometry" => "City: %{[geo][city_name]} | Country: %{[geo][country_name]}" } }
            } else {
                mutate { add_field => { "geometry" => "N/A" } }
            }
        }

    } 
    # Nếu không phải log quan trọng thì drop luôn
    else {
        drop { } 
    }

    # 5. DỌN DẸP
    # Xóa hết các field rác do module KV sinh ra, chỉ giữ lại Schema chuẩn
    if "_grokparsefailure" not in [tags] {
        mutate {
            remove_field => [
                "log_data", "message", "timestamp_raw", "thread", "component", 
                "auth_method", "realmId", "realmName", "sessionId", "token_id", 
                "scope", "redirect_uri", "code_id", "response_type", "consent", 
                "response_mode", "authSessionParentId", "authSessionTabId", "auth_type", "username"
            ]
            remove_tag => ["beats_input_codec_plain_applied"]
        }
    }
  }
}