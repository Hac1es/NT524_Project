filter {
  if [fields][service_type] == "openstack" and [log][file][path] =~ "keystone" {

    grok {
      match => {
        "message" => [
          # --- Log Python Keystone ---
          "%{TIMESTAMP_ISO8601:timestamp} %{NUMBER:pid} %{LOGLEVEL:level} %{NOTSPACE:module} \[%{DATA}\] %{GREEDYDATA:log_message}",

          # --- Log Apache Access (handle: IP, token, empty string) ---
          "%{IP:client_ip} %{NOTSPACE} %{DATA:token} \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{DATA:request_path} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} %{NUMBER} %{NUMBER} %{QS} %{QS:user_agent}"
        ]
      }
    }

    # Nếu gặp log dị hợm, cứu vớt bằng cách copy nguyên văn
    if "_grokparsefailure" in [tags] {
        mutate {
          add_field => { "log_message" => "%{message}" }
          add_tag => ["keystone_raw"]
        }
    }

    # --- BỘ LỌC THÔNG MINH ---

    # 1. Parse token field: "user@realm" → "user" (nếu có)
    if [token] and [token] != "-" and [token] != '""' {
       mutate {
          gsub => ["token", "@.*", ""]
       }
    }
    else {
       mutate {
          remove_field => ["token"]
       }
    }

    # 2. Với Access Log:
    if [request_path] {
       # Bỏ log Healthcheck (curl-healthcheck với GET /)
       if [method] == "GET" and [request_path] == "/" and [user_agent] =~ "curl-healthcheck" {
          drop { }
       }
       
       # === SSO Redirect Phase ===
       else if [request_path] =~ "OS-FEDERATION" and [response_code] == "302" {
          mutate { add_tag => ["sso_initiate"] }
       }
       
       # === OIDC Callback Phase ===
       else if [request_path] =~ "oidc_callback" or [request_path] =~ "redirect_uri" {
          if [response_code] == "302" or [response_code] == "200" {
                mutate { add_tag => ["sso_oidc_auth_success"] }
          }
          else if [response_code] =~ "40[14]" {
             mutate { add_tag => ["sso_oidc_auth_fail"] }
          }
       }
       
       # === Token Creation Phase (after OIDC success) ===
       else if [request_path] =~ "/v3/auth/tokens" {
          if [method] == "POST" and [response_code] == "201" {
             mutate { add_tag => ["token_created"] }
          }
          else if [method] == "GET" and [response_code] == "200" {
             mutate { add_tag => ["token_validate"] }
          }
          else if [response_code] =~ "40[14]" {
             mutate { add_tag => ["token_fail"] }
          }
       }
       
       # === Other Auth Failures ===
       else if [response_code] == "401" or [response_code] == "403" {
          mutate { add_tag => ["keystone_auth_fail"] }
       }
       
       # === Other Access Logs ===
       else {
          mutate { add_tag => ["keystone_access"] }
       }
    }

    # 3. Với Python Log:
    if [log_message] {
       # === Bắt Federation + Mapping Errors ===
       if [log_message] =~ /(?i)(federation|mapping|saml|oidc|issued)/ {
          mutate { add_tag => ["sso_logic"] }
          if [level] in ["ERROR", "CRITICAL"] {
             mutate { add_tag => ["sso_error"] }
          }
       }
       # === Bắt Auth Failures ===
       else if [log_message] =~ /(?i)(unauthorized|notfound|forbidden|not.*found)/ {
          mutate { add_tag => ["keystone_auth_fail"] }
       }
       # === Bắt Deprecated Warnings ===
       else if [log_message] =~ /(?i)deprecated/ {
          mutate { add_tag => ["keystone_warning"] }
       }
       # === Keep all errors/warnings ===
       else if [level] in ["WARNING", "ERROR", "CRITICAL"] {
          mutate { add_tag => ["keystone_error"] }
       }
       # === Drop INFO spam ===
       else {
          drop { }
       }
    }

    # 4. Cleanup fields
    mutate {
      replace => { "service_module" => "keystone" }
      remove_field => ["message", "extra_info", "req_context"]
      remove_tag => ["beats_input_codec_plain_applied"]
    }
  }
}
