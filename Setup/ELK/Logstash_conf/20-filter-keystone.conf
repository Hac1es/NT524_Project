filter {
  if [fields][service_type] == "openstack" and [log][file][path] =~ "keystone" {

    # ==========================================================
    # PHẦN 1: BASE PARSING & CLEANING
    # ==========================================================

    # --- CASE A: Log Apache Keystone ---
    if [log][file][path] =~ "apache" {
      # Lọc Log healthcheck
      if [message] =~ "^-$" or [message] == "" or ([message] =~ "curl-healthcheck" and [message] =~ "GET / ") {
        drop {}
      }

      grok {
        match => {
          "message" => [
            "%{IPORHOST:ip} %{NOTSPACE} %{DATA:token} \[%{HTTPDATE:timestamp}\] \"%{WORD:method} %{DATA:request_path} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} (?:%{NUMBER:bytes}|-) (?:%{NUMBER:duration}|-) %{DATA:referrer} %{DATA:user_agent}"
          ]
        }
        add_tag => ["type_apache"]
      }

      date {
        match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        timezone => "Asia/Ho_Chi_Minh"
        target => "@timestamp"
      }

      mutate {
        add_field => {
          "sp" => "OpenStack_Keystone"
          "idp" => "Keycloak"
          "client_id" => "apache_access"
          "user_id" => "anonymous"
          "outcome" => "unknown"
        }
      }
    }

    # --- CASE B: Log Python Keystone ---
    else {
      mutate { add_tag => ["type_app"] }

      grok {
        match => {
          "message" => [
            "%{TIMESTAMP_ISO8601:timestamp} %{NUMBER} %{LOGLEVEL:level} %{NOTSPACE:module} \[(?<request_id>req-[^\s\]]+) %{GREEDYDATA:log_message}"
          ]
        }
      }

      if [module] =~ "keystone.server.flask.request_processing.req_logging" or [module] =~ "keystone.server.flask.request_processing.middleware.auth_context"{
        if [log_message] =~ "SCRIPT_NAME" or [log_message] =~ "PATH_INFO" or [log_message] =~ "REQUEST_METHOD" or [log_message] =~ "QUERY_STRING" or [log_message] =~ "Authenticating user token process_request" or [log_message] =~ "Validating token access rules against request validate_allowed_request" {
          drop {}
        }
      }

      if [log_message] =~ "direct_maps" or [log_message] =~ "local: \{" or [log_message] =~ "rules: \[" or [log_message] =~ "identity_values" {
        drop {}
      }

      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS", "ISO8601" ]
        timezone => "Etc/UTC"
        target => "@timestamp"
      }

      mutate {
        add_field => {
          "sp" => "OpenStack_Keystone"
          "idp" => "Keycloak"
          "client_id" => "unknown"
          "user_id" => "system"
          "outcome" => "unknown"
        }
      }
    }

    # ==========================================================
    # PHẦN 2: LOGIC NGHIỆP VỤ & TRÍCH XUẤT
    # ==========================================================

    # --- LOGIC CHO APACHE ---
    if "type_apache" in [tags] {
      
      # Clean Token
      if [token] and [token] != "-" and [token] != '""' {
        mutate {
          gsub => ["token", "@.*", ""]
          replace => { "user_id" => "%{token}" }
        }
      }
      mutate { remove_field => ["token"] }

      # Event Type & Outcome
      mutate { replace => { "event_type" => "web_access" } } # Default

      # XÁC ĐỊNH LOẠI SỰ KIỆN SSO
      # Step 1: Người dùng bắt đầu SSO (Chuyển hướng đến Keycloak)
      if [request_path] =~ "OS-FEDERATION" and [response_code] == "302" {
        mutate { 
            replace => {"event_type" => "sso_initiate"} 
            replace => {"outcome" => "success"}
        }
      }

      # Step 2: Kết quả xác thực từ Keycloak (Callback/Redirect URI)
      else if [request_path] =~ "oidc_callback" or [request_path] =~ "redirect_uri" {
        if [response_code] =~ /^(2|3)/ {
          mutate { 
              replace => { "event_type" => "sso_oidc_auth_success" } 
              replace => { "outcome" => "success" }
          }
        } else {
          mutate { 
              replace => { "event_type" => "sso_oidc_auth_fail" } 
              replace => { "outcome" => "failure" }
          }
        }
      }

      # Step 3: Token Created/Failed
      else if [request_path] =~ "/v3/auth/tokens" {
        if [method] == "POST" and [response_code] == "201" {
          mutate { 
              replace => {"event_type" => "token_created"} 
              replace => {"outcome" => "success"}
          }
        }
        else if [response_code] =~ /^[45]/ {
          mutate { 
              replace => {"event_type" => "token_fail"} 
              replace => {"outcome" => "failure"}
          }
        }
        else {
          mutate { 
              replace => {"event_type" => "token_validation"} 
              replace => {"outcome" => "success"}
          }
        }
      }

      # Step 4: Default Outcome cho các log Apache khác
      else if [response_code] =~ /^[45]/ {
         mutate { replace => {"outcome" => "failure"} }
      }
      else {
         mutate { replace => {"outcome" => "success"} }
      }

      # Attributes cho Apache
      mutate {
        add_field => {
          "attributes" => "Referrer: %{referrer} | Method: %{method} | Code: %{response_code}"
        }
      }
    }

    # --- LOGIC CHO PYTHON KEYSTONE ---
    if "type_app" in [tags] and "_grokparsefailure" not in [tags] {
      
      if [log_message] {
        # A. Environment variables
        if [log_message] =~ "Environment variables" {
          grok {
            match => {
              "log_message" => [
                "'OIDC-email':\s*'%{DATA:temp_email}'",
                "'OIDC-preferred_username':\s*'%{DATA:temp_username}'",
                "'OIDC-name':\s*'%{DATA:temp_fullname}'"
              ]
            }
            break_on_match => false
          }
          mutate { 
            replace => {"event_type" => "prepare_step"} 
            replace => { "outcome" => "success" }
            add_field => { "attributes" => "OIDC Email: %{temp_email} | OIDC User: %{temp_username}" }
          }
        }

        # B. Assertion data
        else if [log_message] =~ "assertion data" {
          grok {
            match => {
              "log_message" => [
                "'OIDC-email':\s*'%{DATA:temp_email}'",
                "'HTTP_USER_AGENT':\s*'%{DATA:temp_agent}'",
                "'REMOTE_ADDRESS':\s*'%{IP:ip}'" 
              ]
            }
            break_on_match => false
          }
          mutate { 
            replace => { "event_type" => "assertion_step" } 
            replace => { "outcome" => "success" }
            add_field => { "attributes" => "Agent: %{temp_agent} | Asserted Email: %{temp_email}" }
          }
        }

        # C. Mapped Properties
        else if [log_message] =~ "mapped_properties" {
          grok {
            match => {
              "log_message" => [
                "'name':\s*'%{DATA:temp_os_username}'",
                "'type':\s*'%{DATA:temp_os_type}'"
              ]
            }
            break_on_match => false
          }
          mutate { 
            replace => { "event_type" => "mapping_success" } 
            replace => { "outcome" => "success" }
            replace => { "user_id" => "%{temp_os_username}" }
            add_field => { "attributes" => "Mapped User: %{temp_os_username} | Type: %{temp_os_type}" }
          }
        }

        # D. RBAC Authorization (Final)
        else if [log_message] =~ "RBAC: auth_context" and [log_message] =~ "'token'" {
            grok {
              match => {
                "log_message" => [
                  "'user_id':\s*'%{DATA:temp_user_id}'",
                  "'project_id':\s*'%{DATA:temp_project_id}'",
                  "'roles':\s*\[%{DATA:temp_roles}\]" # FIX: Pattern List ['...']
                ]
              }
              break_on_match => false
            }
            
            mutate { 
              replace => { "event_type" => "sso_auth_complete" } 
              replace => { "outcome" => "success" }
              replace => { "user_id" => "%{temp_user_id}" }
              replace => { "client_id" => "%{temp_project_id}" }
              add_field => { "attributes" => "Project: %{temp_project_id} | Roles: %{temp_roles}" }
            }
        }
        
        # Giữ auth_context, bỏ Authorization granted/Authorizing
        else if [log_message] =~ "RBAC" {
            drop {} 
        }

        # Default Outcome for other logs
        else {
             # QUAN TRỌNG: Giữ lại nếu là Lỗi hoặc Cảnh báo (để debug hệ thống)
             if [level] == "ERROR" or [level] == "WARN" or [level] == "CRITICAL" {
                 mutate { 
                    replace => { "outcome" => "failure" }
                    # Lấy nội dung lỗi đưa vào attributes để đọc cho dễ
                    add_field => { "attributes" => "Message: %{log_message}" }
                 }
             }
             
             # CÒN LẠI: Log DEBUG/INFO mà không khớp các rule quan trọng ở trên -> RÁC -> DROP
             else {
                 drop {}
          }
        }
      }
    }

    # ==========================================================
    # PHẦN 3: COMMON ENRICHMENT & CLEANUP
    # ==========================================================

    # 1. GeoIP (Chạy chung cho cả Apache và Python nếu có field [ip])
    # Loại trừ IP nội bộ VIP 192.168.1.254 để tránh lỗi lookup
    if [ip] and [ip] != "-" and [ip] != "" and [ip] != "192.168.1.254" {
      geoip {
        source => "ip"
        target => "geo"
        ecs_compatibility => disabled
        fields => ["city_name", "location", "country_name"]
      }

      if [geo][location] {
        mutate {
          add_field => { "geometry" => "City: %{[geo][city_name]} | Country: %{[geo][country_name]}" }
        }
      } else {
        mutate { add_field => { "geometry" => "N/A" } }
      }
    }

    # 2. Cleanup
    # Xóa tất cả các field tạm dùng để grok, chỉ giữ lại Schema chuẩn
    if "_grokparsefailure" not in [tags] {
      mutate {
        remove_field => [
          "request_context_raw", "source_code_path", "timestamp", "log_message",
          "temp_email", "temp_username", "temp_fullname", "temp_agent",
          "temp_os_username", "temp_os_type", "temp_os_domain",
          "temp_user_id", "temp_project_id", "temp_roles",
          "openstack_email", "openstack_username", "openstack_group_ids" 
        ]
        remove_tag => ["beats_input_codec_plain_applied"]
      }
    }
  }
}