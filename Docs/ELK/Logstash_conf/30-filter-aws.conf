filter {
  # ===== CHỈ XỬ LÝ LOG AWS (không có service_type từ Filebeat) =====
  if ![fields][service_type] {
    
    # Chỉ xử lý nếu event có chứa mảng Records (đặc trưng của AWS CloudTrail)
    if [Records] {
      
      # 1. Tách mảng Records thành từng event riêng biệt
      split {
        field => "Records"
      }

      # Rename để xử lý cho gọn, ct = cloudtrail
      mutate {
        rename => { "Records" => "ct" }
      }

      # 2. Lọc đúng 2 loại event bạn cần cho SIEM
      if [ct][eventName] == "UserAuthentication" and [ct][eventSource] == "signin.amazonaws.com" {
        mutate { add_tag => ["aws_signin"] }
      } 
      else if [ct][eventName] == "Authenticate" and [ct][eventSource] == "sso.amazonaws.com" {
        mutate { add_tag => ["aws_sso"] }
      } 
      else {
        # Loại bỏ các event API khác để tiết kiệm tài nguyên
        drop { }
      }

      # 3. NORMALIZATION: Map sang Schema chung
      
      # A. Timestamp
      date {
        match => [ "[ct][eventTime]", "ISO8601" ]
        timezone => "Etc/UTC"
        target => "@timestamp"
      }

      # B. Các trường chung
      mutate {
        add_field => {
          "event_type" => "%{[ct][eventName]}"
          "ip"         => "%{[ct][sourceIPAddress]}"
          "user_agent" => "%{[ct][userAgent]}"
          "client_id"  => "%{[ct][recipientAccountId]}"
          "idp"        => "Keycloak" 
          "sp"         => "AWS_IAM_Identity_Center"
        }
      }

      # C. Logic riêng cho UserAuthentication (Sign-in)
      if "aws_signin" in [tags] {
        mutate {
          replace => { "user_id" => "%{[ct][additionalEventData][UserName]}" }
        }
        
        if [ct][serviceEventDetails][UserAuthentication] == "Success" {
          mutate { add_field => { "outcome" => "success" } }
        } else {
          mutate { add_field => { "outcome" => "failure" } }
        }

        mutate {
          add_field => {
            "attributes" => "LoginTo: %{[ct][additionalEventData][LoginTo]} | Method: %{[ct][additionalEventData][CredentialType]} | Workflow: %{[ct][additionalEventData][AuthWorkflowID]}"
          }
        }
      }

      # D. Logic riêng cho Authenticate (SSO Portal)
      if "aws_sso" in [tags] {
        mutate {
          replace => { "user_id" => "%{[ct][userIdentity][onBehalfOf][userId]}" }
        }

        if [ct][errorCode] {
          mutate { add_field => { "outcome" => "failure" } }
        } else {
          mutate { add_field => { "outcome" => "success" } }
        }

        mutate {
          add_field => {
            "attributes" => "IdentityStore: %{[ct][userIdentity][onBehalfOf][identityStoreArn]} | CredentialId: %{[ct][userIdentity][credentialId]}"
          }
        }
      }

      # 4. GEOIP LOOKUP (Sử dụng logic từ Keystone/Keycloak của bạn)
      if [ip] and [ip] != "-" {
        geoip {
          source => "ip"
          target => "geo"
          ecs_compatibility => disabled
          fields => ["city_name", "country_name", "location"]
        }
        if [geo][location] {
          mutate { add_field => { "geometry" => "City: %{[geo][city_name]} | Country: %{[geo][country_name]}" } }
        }
      }

      # 5. CLEANUP: Xóa toàn bộ dữ liệu thừa, đặc biệt là [event][original] rất nặng
      mutate {
        remove_field => [ "ct", "Records", "event", "message", "tags", "@version" ]
      }
    }
  }
}