filter {
  if [fields][service_type] == "keycloak" {
    
    # 1. CẮT CHUỖI
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp}\s+%{LOGLEVEL:level}\s+\[%{DATA:module}\]\s+\(%{DATA:thread}\)\s+%{GREEDYDATA:log_message}" 
      }
    }

    # 2. LỌC RÁC
    # Vì log text không có field [type] như JSON, ta phải lọc dựa trên [level] và từ khóa trong [message]
    # Giữ lại nếu là Lỗi (WARN/ERROR) HOẶC chứa từ khóa quan trọng (login, federation...)
    if [level] in ["WARN", "ERROR", "FATAL"] or [log_message] =~ /(?i)(login|logout|federation|client|token|sso)/ {
    } 
    else {
       drop { }
    }

    # 3. DÁN NHÃN & DỌN DẸP
    mutate { 
      add_tag => ["keycloak_sso"]
      remove_field => ["message"]
      remove_tag => ["beats_input_codec_plain_applied"]
    }
  }
}
