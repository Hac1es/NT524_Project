---
- name: Incident Response - Revoke Token
  hosts: localhost
  gather_facts: no
  vars:
    # Cấu hình Keycloak
    keycloak_url: "https://sso.hippi.work"
    realm_name: "cloud" # Realm chứa user (ví dụ: master hoặc customer)
    admin_user: "{{ lookup('env', 'KEYCLOAK_ADMIN_USER') }}" # User có quyền quản trị Keycloak
    admin_pass: "{{ lookup('env', 'KEYCLOAK_ADMIN_PASSWORD') }}"

  tasks:
    # BƯỚC 1: Lấy Admin Access Token để được quyền gọi API
    - name: 1. Authenticate to Keycloak
      uri:
        url: "{{ keycloak_url }}/realms/master/protocol/openid-connect/token"
        method: POST
        body_format: form-urlencoded
        body:
          username: "{{ admin_user }}"
          password: "{{ admin_pass }}"
          grant_type: "password"
          client_id: "admin-cli"
        validate_certs: no
      register: keycloak_auth
      failed_when: keycloak_auth.status != 200

    # BƯỚC 2: Tìm ID (UUID) của user dựa trên username
    # Keycloak API thao tác qua UUID chứ không phải username
    - name: 2. Find User ID
      uri:
        url: "{{ keycloak_url }}/admin/realms/{{ realm_name }}/users?username={{ suspect_username }}&exact=true"
        method: GET
        headers:
          Authorization: "Bearer {{ keycloak_auth.json.access_token }}"
        validate_certs: no
      register: user_info

    - name: Fail if user not found
      fail:
        msg: "Không tìm thấy user {{ suspect_username }}"
      when: user_info.json | length == 0

    # BƯỚC 3: Logout toàn bộ session của User đó (Revoke Consent)
    - name: 3. Revoke Sessions
      uri:
        url: "{{ keycloak_url }}/admin/realms/{{ realm_name }}/users/{{ user_info.json[0].id }}/logout"
        method: POST
        headers:
          Authorization: "Bearer {{ keycloak_auth.json.access_token }}"
        status_code: 204
        validate_certs: no

    # BƯỚC 4: Gửi thông báo
    - name: Notification
      debug:
        msg: "Đã thu hồi token của {{ suspect_username }} (UUID: {{ user_info.json[0].id }})"
